<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  


<mapper namespace="com.bit189.haroo.dao.CommentDao">

  <resultMap id="commentMap" type="Comment">
    <id column="com_no" property="no"/>
    <result column="feed_no" property="feedNo"/>
    <result column="comment" property="content"/>
    <result column="com_dttm" property="registeredDate"/>
    <result column="com_stat" property="state"/>
    
    <association property="writer" javaType="Member"> <!-- 댓글작성자 -->
      <id column="mno" property="no"/>
      <result column="profile_pic" property="profilePicture"/>
      <result column="name" property="name"/>
      <result column="nickname" property="nickname"/>
      <result column="mstat" property="state"/>
      <result column="mrno" property="rank"/>
    </association> 
    
    <!-- <collection property="reComments" ofType="ReComment"> 대댓글
      <id column="recom_no" property="no"/>
      <result column="content" property="content"/>
      <result column="rdttm" property="registeredDate"/>
      <result column="recom_stat" property="state"/>
      
      <association property="reWriter" javaType="Member"> 대댓글작성자
        <id column="rmmno" property="no"/>
	      <result column="rmprofile_pic" property="profilePicture"/>
	      <result column="rmname" property="name"/>
	      <result column="rmnickname" property="nickname"/>
      </association>
      
      <association property="taggedMember" javaType="Member"> 대댓글에서 태그된 멤버
        <id column="tmmno" property="no"/>
        <result column="tmname" property="name"/>
        <result column="tmnickname" property="nickname"/>
      </association>
    </collection> -->
  </resultMap>
  
  
  <select id="findByComments" resultMap="commentMap" parameterType="int">
		select
			c.com_no,
			c.feed_no,
			c.comment,
			c.com_dttm,
			c.com_stat,
			m.mno,
			m.name,
			m.nickname,
			m.profile_pic,
			m.mstat,
			m.mrno
		from
			har_comment c
			inner join har_member m on c.mno=m.mno
		where
			c.feed_no=#{no}
			and c.com_stat=1
		order by
		  com_dttm desc, com_no desc
  </select>
  
  
  <select id="findByComment" parameterType="int" resultMap="commentMap">
    select
      c.com_no,
      c.feed_no,
      c.comment,
      c.com_dttm,
      c.com_stat,
      m.mno,
      m.name,
      m.nickname,
      m.profile_pic,
      m.mstat,
      m.mrno
    from
      har_comment c
      inner join har_member m on c.mno=m.mno
    where
      c.feed_no=#{no}
      and c.com_stat=1
  </select>
  
  
  <insert id="insert" parameterType="Comment">
    insert into har_comment (feed_no, mno, comment)
    value (#{feedNo}, #{writer.no}, #{content})
  </insert>
  
  <delete id="delete" parameterType="int">
    update har_comment set
        com_stat=0
    where com_no = #{no}
  </delete>
  
  
  <select id="commentCount" parameterType="int" resultType="String">
    select 
    (select count(*) from har_comment where feed_no=#{no} and com_stat=1) +
    (select count(*) from har_recomment r inner join har_comment c on r.com_no=c.com_no where c.feed_no=#{no} and r.recom_stat=1) com_cnt
  </select>
  
  
  
  


















</mapper>
  
  